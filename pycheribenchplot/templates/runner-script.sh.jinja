#!/bin/bash
#
# ** Do not edit **
# This script is generated by cheri-benchplot.
#

set -e

{% macro debug(msg) %}
  {% if verbose %}
    echo "DEBUG: {{ msg }}"
  {% endif %}
{% endmacro %}

echo "Run benchmark configuration ID={{ dataset_id }} with {{ iterations }} iterations."
echo "Instance '{{ instance.name }}' ID={{ dataset_gid }}."
echo "Parameters:"
{% for pkey, pval in parameters.items() %}
echo -e "\t{{ pkey }}='{{ pval }}'"
{% endfor %}

{% macro gen_hook(phase, hook) %}
  {{ debug("{{ phase }} hook '{{ hook.name }}'") }}
  {% if hook.template -%}
    {% include 'templates/hooks/%s' % hook.template %}
  {% else %}
    {% for cmd in hook.commands %}
      {{ cmd }}
    {% endfor %}
  {% endif %}
{% endmacro %}

{% macro gen_iter_hook(phase, iteration, hook) %}
  {{ debug("{{ phase }} iteration {{ iteration }} hook '{{ hook.name }}'") }}
  {% if hook.template %}
    {% include 'hooks/%s' % hook.template %}
  {% else %}
    {% for cmd in hook.commands %}
      {{ cmd }}
    {% endfor %}
  {% endif %}
{% endmacro %}

#### Global setup
{% block global_setup %}
  echo "Global benchmark setup"
  {% for hook in setup_hooks -%}
    {{ gen_hook("Setup", hook) }}
  {% endfor %}
{% endblock %}

#### Run loop
{% block iteration_loop %}
  echo "Run benchmark for {{ iterations }} iterations"
  for ITERATION in $(seq 0 {{ iterations - 1 }}); do
    {%- set current_iteration = "${ITERATION}" -%}
    {%- block iteration_setup scoped %}
      {% for hook in iter_setup_hooks %}
        {{ gen_iter_hook("Setup", current_iteration, hook) }}
      {% endfor %}
    {% endblock iteration_setup -%}

    {%- block iteration_exec scoped %}
      {% for hook in iter_exec_hooks %}
        {{ gen_iter_hook("Exec", current_iteration, hook) }}
      {% endfor %}
    {% endblock iteration_exec -%}

    {%- block iteration_teardown scoped %}
      {% for hook in iter_teardown_hooks %}
        {{ gen_iter_hook("Teardown", current_iteration, hook) }}
      {% endfor %}
    {% endblock iteration_teardown -%}
  done
  echo "Benchmark done"
{% endblock iteration_loop %}

#### Global teardown
{% block global_teardown %}
  echo "Global benchmark teardown"
  {% for hook in teardown_hooks -%}
    {{ gen_hook("Teardown", hook) }}
  {%- endfor %}
{% endblock %}
